name: MT6739 Kernel Build

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: 'Kernel defconfig (e.g., k39tv1_64_bsp_defconfig)'
        required: true
        default: 'k39tv1_64_bsp_defconfig'
      make_target:
        description: 'Make target (default: Image.gz-dtb)'
        required: false
        default: 'Image.gz-dtb'
      kernel_repo_url:
        description: 'Kernel repo URL to clone (default: cateajansmedya/android_kernel_mediatek_mt6739)'
        required: false
        default: 'https://github.com/cateajansmedya/android_kernel_mediatek_mt6739'

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential bc flex bison libssl-dev libncurses-dev gcc-aarch64-linux-gnu git python3

      - name: Clone kernel sources
        run: |
          rm -rf kernel_src || true
          git clone "${{ github.event.inputs.kernel_repo_url }}" kernel_src
          (cd kernel_src && git submodule update --init --recursive || true)

      - name: List available defconfigs
        run: |
          cd kernel_src
          echo "Available defconfigs under arch/arm64/configs (first 200 entries):"
          ls arch/arm64/configs | sed -n '1,200p' || true

      - name: Configure
        env:
          ARCH: arm64
          CROSS_COMPILE: aarch64-linux-gnu-
        run: |
          cd kernel_src
          DEFCONFIG_INPUT="${{ github.event.inputs.defconfig }}"
          DEFCONFIG=""
          for cfg in ${DEFCONFIG_INPUT} k39tv1_64_bsp_defconfig k63v2_64_bsp_defconfig k63v1_64_bsp_defconfig; do
            if [ -f "arch/arm64/configs/${cfg}" ]; then DEFCONFIG="${cfg}"; break; fi
          done
          if [ -z "${DEFCONFIG}" ]; then
            echo "No known defconfig found. Please choose one from the listing above."
            exit 1
          fi
          echo "Using defconfig: ${DEFCONFIG}"
          make ${DEFCONFIG} ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE}
          # Merge ACM config fragment
          cat ../scripts/acm_defconfig_fragment.config >> .config || true
          yes "" | make olddefconfig ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE}

      - name: Build
        env:
          ARCH: arm64
          CROSS_COMPILE: aarch64-linux-gnu-
        run: |
          cd kernel_src
          make -j$(nproc) ${{ github.event.inputs.make_target }} ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE}
          mkdir -p out
          cp arch/arm64/boot/Image.gz-dtb out/ || true

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mt6739-kernel-out
          path: kernel_src/out/**